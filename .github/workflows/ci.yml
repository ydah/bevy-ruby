name: CI
on:
  push:
    branches:
      - main
  pull_request:
permissions:
  contents: read
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test:
    name: Ruby + Rust
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
        ruby:
          - '3.2'
          - '3.3'
          - '3.4'
          - '4.0'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install build dependencies
        shell: bash
        run: |
          set -euxo pipefail
          SUDO=""
          if command -v sudo >/dev/null 2>&1; then
            SUDO="sudo"
          fi

          if command -v apt-get >/dev/null 2>&1; then
            $SUDO apt-get update
            $SUDO apt-get install -y \
              pkg-config \
              libasound2-dev \
              libudev-dev \
              libwayland-dev \
              libxkbcommon-dev \
              libx11-dev \
              libxi-dev \
              libxrandr-dev \
              libxcursor-dev \
              libxinerama-dev
          elif command -v apt >/dev/null 2>&1; then
            $SUDO apt update
            $SUDO apt install -y \
              pkg-config \
              libasound2-dev \
              libudev-dev \
              libwayland-dev \
              libxkbcommon-dev \
              libx11-dev \
              libxi-dev \
              libxrandr-dev \
              libxcursor-dev \
              libxinerama-dev
          elif command -v dnf >/dev/null 2>&1; then
            $SUDO dnf install -y \
              pkgconf-pkg-config \
              alsa-lib-devel \
              systemd-devel \
              wayland-devel \
              libxkbcommon-devel \
              libX11-devel \
              libXi-devel \
              libXrandr-devel \
              libXcursor-devel \
              libXinerama-devel
          elif command -v yum >/dev/null 2>&1; then
            $SUDO yum install -y \
              pkgconfig \
              alsa-lib-devel \
              systemd-devel \
              wayland-devel \
              libxkbcommon-devel \
              libX11-devel \
              libXi-devel \
              libXrandr-devel \
              libXcursor-devel \
              libXinerama-devel
          elif command -v brew >/dev/null 2>&1; then
            brew install pkg-config
          else
            echo "No supported package manager found; skipping dependency install."
          fi
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2
      - name: Rust check
        run: cargo check --workspace
      - name: Compile native extension
        run: bundle exec rake compile
      - name: Run specs
        run: bundle exec rake spec
